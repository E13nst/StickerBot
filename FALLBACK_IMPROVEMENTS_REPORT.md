# Отчет: Улучшение fallback логики для inline_message_id

## Измененные файлы

### 1. `src/bot/handlers/generation.py`

**Изменения:**
- Добавлена трехступенчатая fallback цепочка для `inline_message_id` при `should_convert_to_webp=True`:
  1. **Попытка A**: `edit_message_media(InputMediaDocument(InputFile(webp_bytes)))` - как было
  2. **Попытка B** (новое): `edit_message_media(InputMediaPhoto(InputFile(bytes)))` - bytes-based photo fallback
  3. **Попытка C** (last resort): `edit_message_text()` с инструкцией и кнопкой "Open in bot"

- Улучшено логирование: используется `repr(error)` вместо `type(error).__name__` для лучшей диагностики
- Добавлен fallback на photo с bytes также в случае ошибки конвертации (в блоке `except Exception as conversion_error`)

**Ключевые детали:**
- Photo fallback использует те же bytes (webp_bytes или image_bytes), НЕ URL
- Caption для photo fallback сокращен до пустого или "Generated by STIXLY" для "sticker-like" вида
- Кнопка "Open in bot" создается только если доступен `context.bot.username`
- Текст last resort: "⚠️ Generated, but Telegram cannot preview media here. Open bot chat to receive file."

### 2. `tests/test_bot/handlers/test_generation.py`

**Изменения:**
- **Удален** старый тест `test_update_message_with_image_should_convert_to_webp_fallback_to_text_for_inline`
- **Добавлен** новый тест `test_update_message_with_image_should_convert_to_webp_fallback_to_photo_for_inline`:
  - Проверяет, что при ошибке document редактирования пробуется photo fallback
  - Проверяет, что `edit_message_media` вызывается дважды (document, затем photo)
  - Проверяет, что `edit_message_text` НЕ вызывается при успешном photo fallback

- **Добавлен** новый тест `test_update_message_with_image_should_convert_to_webp_double_fail_for_inline`:
  - Проверяет двойной фейл (document fail + photo fail)
  - Проверяет, что `edit_message_text` вызывается как last resort
  - Проверяет корректность текста сообщения

## Новая fallback цепочка

```
should_convert_to_webp=True + inline_message_id:
├─ Попытка A: InputMediaDocument(webp_bytes)
│  └─ Успех → ✅ Готово
│  └─ Ошибка ↓
├─ Попытка B: InputMediaPhoto(bytes)  [НОВОЕ]
│  └─ Успех → ✅ Готово
│  └─ Ошибка ↓
└─ Попытка C: edit_message_text("⚠️ Generated, but Telegram cannot preview...")  [LAST RESORT]
   └─ Кнопки: "Open in bot" + "Regenerate"
```

## Результаты

✅ **Все тесты проходят** (5/5)
- `test_update_message_with_image_should_convert_to_webp_never_uses_photo` ✅
- `test_update_message_with_image_should_convert_to_webp_fallback_to_photo_for_inline` ✅ (новый)
- `test_update_message_with_image_should_convert_to_webp_double_fail_for_inline` ✅ (новый)
- `test_update_message_with_image_should_convert_to_webp_fallback_to_document_for_chat` ✅
- `test_update_message_with_image_no_convert_uses_photo` ✅

✅ **Логирование улучшено**: используется `repr(error)` для лучшей диагностики

✅ **Happy-path не изменен**: основной путь (успешное редактирование document) работает как раньше

✅ **Ничего не сломано**: логика для `chat_id/message_id` не изменена, все существующие тесты проходят

## Acceptance Criteria

✅ В Telegram MiniApp / inline_message_id больше не бывает состояния "только текст" при успешной генерации (есть photo fallback)

✅ При падении document-редактирования inline, бот показывает картинку через photo bytes fallback

✅ Ничего не меняется для chat_id/message_id ветки (там send_document как сейчас)

✅ Все тесты проходят








